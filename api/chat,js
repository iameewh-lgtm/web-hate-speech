import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "@google/generative-ai";

export default async function handler(req, res) {
    // üëáüëáüëá D√ÅN KEY GOOGLE C·ª¶A B·∫†N V√ÄO ƒê√ÇY üëáüëáüëá
    const API_KEY = "AIzaSyDz-WxEJjP84yzecNi8_J_I6LTZx_UKDME"; 

    if (req.method !== 'POST') return res.status(405).json({ error: 'Method Not Allowed' });

    try {
        const { inputs } = req.body;
        console.log("Input:", inputs); // In ra log ƒë·ªÉ check

        // 1. D·ªäCH TEENCODE (Javascript thu·∫ßn)
        let cleanText = inputs.toLowerCase()
            .replace(/\./g, '') // X√≥a d·∫•u ch·∫•m
            .replace(/(?<=\b[a-z])\s+(?=[a-z]\b)/g, ''); // G·ªôp ch·ªØ r·ªùi

        const dict = {
            "cc": "c·ª•c c·ª©t", "cmm": "con m·∫π m√†y", "dcm": "ƒë·ªãt con m·∫π",
            "dm": "ƒë·ªãt m·∫π", "ƒëm": "ƒë·ªãt m·∫π", "vcl": "v√£i c·∫£ l·ªìn",
            "vl": "v√£i l·ªìn", "clm": "c√°i l·ªù m√°", "cdmm": "con ƒëƒ© m·∫π m√†y",
            "cdcmm": "con ƒëƒ© c√°i m·∫π m√†y", "cmn": "con m·∫π n√≥", 
            "dell": "ƒë√©o", "ƒëell": "ƒë√©o", "m": "m√†y", "t": "tao"
        };
        cleanText = cleanText.split(' ').map(w => dict[w] || w).join(' ');

        // 2. G·ªåI GEMINI (T·∫Øt Safety Filter)
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ 
            model: "gemini-1.5-flash",
            safetySettings: [
                { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE },
            ]
        });

        const prompt = `Ph√¢n lo·∫°i c√¢u n√†y: "${cleanText}" (G·ªëc: "${inputs}"). 
        Ch·ªâ tr·∫£ v·ªÅ JSON: {"label": "LABEL_0" (s·∫°ch) ho·∫∑c "LABEL_1" (x√∫c ph·∫°m) ho·∫∑c "LABEL_2" (th√π gh√©t), "score": 0.99}`;

        const result = await model.generateContent(prompt);
        const response = await result.response;
        let text = response.text().replace(/```json|```/g, '').trim();
        
        // Fix l·ªói n·∫øu Google tr·∫£ v·ªÅ th·ª´a k√Ω t·ª±
        const firstBrace = text.indexOf('{');
        const lastBrace = text.lastIndexOf('}');
        if (firstBrace !== -1 && lastBrace !== -1) {
            text = text.substring(firstBrace, lastBrace + 1);
        }

        const data = JSON.parse(text);
        return res.status(200).json([data]);

    } catch (error) {
        console.error("L·ªói:", error);
        // Tr·∫£ v·ªÅ k·∫øt qu·∫£ 'An to√†n' gi·∫£ thay v√¨ l·ªói, ƒë·ªÉ web kh√¥ng b·ªã s·∫≠p
        return res.status(200).json([
            { label: "LABEL_1", score: 0.99, error: "AI l·ªói nh·∫π, m·∫∑c ƒë·ªãnh c·∫£nh b√°o" }
        ]);
    }
}
